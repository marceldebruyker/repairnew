---
const pathname = Astro.url.pathname
---
<header class="sticky top-0 z-50 backdrop-blur bg-slate-900/80 border-b border-slate-700">
  <nav class="mx-auto max-w-7xl px-6 lg:px-8 h-16 flex items-center justify-between" role="navigation" aria-label="Hauptnavigation">
    <a href="/" class="font-extrabold tracking-tight text-xl text-slate-100">Repair Café <span class="text-brand-400">Leonberg</span></a>

    <!-- Desktop Menu -->
    <ul class="hidden md:flex gap-6 text-sm">
      <li><a class="hover:underline text-slate-300 hover:text-slate-100" href="/events" aria-current={pathname.startsWith('/events') ? 'page' : undefined}>Termine</a></li>
      <li><a class="hover:underline text-slate-300 hover:text-slate-100" href="/news" aria-current={pathname.startsWith('/news') ? 'page' : undefined}>News</a></li>
      <li><a class="hover:underline text-slate-300 hover:text-slate-100" href="/#mitmachen">Mitmachen</a></li>
      <li><a class="hover:underline text-slate-300 hover:text-slate-100" href="/#anfahrt">Anfahrt</a></li>
      <li><a class="hover:underline text-slate-300 hover:text-slate-100" href="/#spenden">Spenden</a></li>
      <li><a class="hover:underline text-slate-300 hover:text-slate-100" href="/admin">Admin</a></li>
    </ul>

    <div class="flex items-center gap-4">
      <a href="/events" class="hidden md:block rounded-md bg-brand-600 px-3.5 py-2 text-sm font-semibold text-white shadow hover:bg-brand-700">Termin buchen</a>

      <!-- Mobile Menu Button -->
      <button 
        id="mobile-menu-button"
        class="md:hidden flex flex-col justify-center items-center w-8 h-8 space-y-1 group relative z-10"
        aria-label="Menü öffnen"
        aria-expanded="false"
        aria-controls="mobile-panel"
      >
        <span data-bar class="w-6 h-0.5 bg-slate-300 transition-transform duration-300 ease-in-out group-hover:bg-brand-400 origin-center"></span>
        <span data-bar class="w-6 h-0.5 bg-slate-300 transition-opacity duration-200 ease-in-out group-hover:bg-brand-400"></span>
        <span data-bar class="w-6 h-0.5 bg-slate-300 transition-transform duration-300 ease-in-out group-hover:bg-brand-400 origin-center"></span>
      </button>
    </div>
  </nav>

  <!-- Mobile Menu (Full-screen Overlay) -->
  <div id="mobile-root" class="md:hidden fixed inset-0 z-50 pointer-events-none" aria-hidden="true">
    <div id="mobile-backdrop" class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm opacity-0 transition-opacity duration-300 ease-out"></div>
    <section id="mobile-panel" role="dialog" aria-modal="true" aria-labelledby="mobile-title" tabindex="-1" class="absolute inset-0 translate-y-full transition-transform duration-300 ease-out bg-gradient-to-b from-slate-900 to-slate-950 flex flex-col">
      <div class="flex items-center justify-between px-6 pt-6 pb-4 border-b border-slate-800">
        <h2 id="mobile-title" class="text-xl font-bold text-slate-100">Repair Café <span class="text-brand-400">Leonberg</span></h2>
        <button id="mobile-menu-close" class="p-2 hover:bg-slate-800 rounded-lg transition-colors" aria-label="Menü schließen">
          <svg class="w-6 h-6 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
      <nav class="flex-1 overflow-y-auto px-2 sm:px-6 py-4">
        <ul class="divide-y divide-slate-800">
          <li><a class="block py-5 px-4 text-2xl font-semibold text-slate-100 hover:text-brand-400" href="/events">Termine</a></li>
          <li><a class="block py-5 px-4 text-2xl font-semibold text-slate-100 hover:text-brand-400" href="/news">News</a></li>
          <li><a class="block py-5 px-4 text-2xl font-semibold text-slate-100 hover:text-brand-400" href="/#mitmachen">Mitmachen</a></li>
          <li><a class="block py-5 px-4 text-2xl font-semibold text-slate-100 hover:text-brand-400" href="/#anfahrt">Anfahrt</a></li>
          <li><a class="block py-5 px-4 text-2xl font-semibold text-slate-100 hover:text-brand-400" href="/#spenden">Spenden</a></li>
          <li><a class="block py-5 px-4 text-2xl font-semibold text-slate-100 hover:text-brand-400" href="/admin">Admin</a></li>
        </ul>
      </nav>
      <div class="px-6 pb-8 pt-4 border-t border-slate-800">
        <a href="/events" class="block w-full text-center rounded-xl bg-brand-600 px-6 py-4 text-lg font-semibold text-white hover:bg-brand-700 shadow">Termin buchen</a>
      </div>
    </section>
  </div>

  <script>
    // Mobile drawer with overlay: solid, accessible, focus-trapped
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const root = document.getElementById('mobile-root');
    const panel = document.getElementById('mobile-panel');
    const overlay = document.getElementById('mobile-backdrop');
    const mobileMenuClose = document.getElementById('mobile-menu-close');
    const main = document.getElementById('main-content');
    if (mobileMenuButton && root && panel && overlay) {
      let isOpen = false;
      let lastFocused = null;
      const getFocusable = (root) => root.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
      const setHamburgerState = (open) => {
        const bars = mobileMenuButton.querySelectorAll('[data-bar]');
        if (open) {
          bars[0]?.classList.add('translate-y-1.5','rotate-45');
          bars[1]?.classList.add('opacity-0');
          bars[2]?.classList.add('-translate-y-1.5','-rotate-45');
        } else {
          bars[0]?.classList.remove('translate-y-1.5','rotate-45');
          bars[1]?.classList.remove('opacity-0');
          bars[2]?.classList.remove('-translate-y-1.5','-rotate-45');
        }
      };
      const trapTab = (e) => {
        if (!isOpen || e.key !== 'Tab') return;
        const focusables = Array.from(getFocusable(panel));
        if (focusables.length === 0) return;
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      };
      const openMenu = () => {
        if (isOpen) return;
        isOpen = true;
        lastFocused = document.activeElement;
        document.body.style.overflow = 'hidden';
        root.classList.remove('pointer-events-none');
        root.classList.add('pointer-events-auto');
        panel.classList.remove('translate-y-full');
        panel.classList.add('translate-y-0');
        overlay.classList.remove('opacity-0');
        overlay.classList.add('opacity-100');
        mobileMenuButton.setAttribute('aria-expanded', 'true');
        mobileMenuButton.setAttribute('aria-label', 'Menü schließen');
        setHamburgerState(true);
        main?.setAttribute('aria-hidden', 'true');
        const focusables = getFocusable(panel);
        (focusables[0] || mobileMenuClose || panel).focus();
        document.addEventListener('keydown', trapTab);
      };
      const closeMenu = () => {
        if (!isOpen) return;
        isOpen = false;
        document.body.style.overflow = '';
        panel.classList.add('translate-y-full');
        panel.classList.remove('translate-y-0');
        overlay.classList.add('opacity-0');
        overlay.classList.remove('opacity-100');
        root.classList.add('pointer-events-none');
        root.classList.remove('pointer-events-auto');
        mobileMenuButton.setAttribute('aria-expanded', 'false');
        mobileMenuButton.setAttribute('aria-label', 'Menü öffnen');
        setHamburgerState(false);
        main?.removeAttribute('aria-hidden');
        document.removeEventListener('keydown', trapTab);
        if (lastFocused && typeof lastFocused.focus === 'function') {
          lastFocused.focus();
        } else {
          mobileMenuButton.focus();
        }
      };
      mobileMenuButton.addEventListener('click', () => (isOpen ? closeMenu() : openMenu()));
      mobileMenuClose?.addEventListener('click', closeMenu);
      panel.querySelectorAll('a').forEach((link) => link.addEventListener('click', closeMenu));
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && isOpen) closeMenu(); });
      overlay.addEventListener('click', closeMenu);
    }
  </script>
</header>
